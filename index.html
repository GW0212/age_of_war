<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>전쟁시대1 (Age of War) - Ruffle Web Player</title>
  <meta name="description" content="Ruffle(Flash 에뮬레이터)로 전쟁시대1 SWF를 실행하는 단일 파일 웹사이트" />
  <style>
    :root {
      --bg: #0b0f14; /* 차콜 네이비 */
      --panel: #121821;
      --accent: #59b1ff;
      --muted: #8aa0b3;
      --text: #e8eef5;
      --danger: #ff6b6b;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, "맑은 고딕", Arial, "Helvetica Neue", Helvetica, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 80% -20%, #132033 0%, var(--bg) 60%);
      color: var(--text);
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-height: 100dvh;
    }

    header {
      padding: 18px 20px;
      display: flex;
      align-items: center;
      gap: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0));
      border-bottom: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(6px);
      position: sticky; top: 0; z-index: 50;
    }
    header h1 { margin: 0; font-size: 18px; font-weight: 700; letter-spacing: .2px; }
    .tag { font-size: 12px; color: var(--muted); border: 1px solid rgba(255,255,255,0.12); padding: 2px 8px; border-radius: 999px; }

    .wrap {
      max-width: 1080px; width: 100%; margin: 14px auto; padding: 0 16px 24px;
      display: grid; gap: 12px;
    }

    .toolbar {
      background: rgba(18, 24, 33, 0.9);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 10px;
      display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
    }

    button, label.btn {
      appearance: none; border: 1px solid rgba(255,255,255,0.12);
      background: #0d141d; color: var(--text);
      padding: 8px 12px; border-radius: 10px; cursor: pointer;
      font-weight: 600; font-size: 14px; letter-spacing: .2px;
      transition: transform .05s ease, background .2s ease, border-color .2s ease;
      display: inline-flex; align-items: center; gap: 8px;
      user-select: none;
    }
    button:hover, label.btn:hover { background: #101a26; border-color: rgba(255,255,255,0.22); }
    button:active, label.btn:active { transform: translateY(1px); }
    .btn-accent { border-color: rgba(89,177,255,.5); box-shadow: inset 0 0 0 1px rgba(89,177,255,.25); }
    .btn-danger { border-color: rgba(255,107,107,.4); }

    input[type="range"] { accent-color: var(--accent); }

    .flex { display: flex; align-items: center; gap: 10px; }
    .grow { flex: 1 1 auto; }
    .spacer { flex: 1 1 0; }

    .player-shell {
      background: #0b121a;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
      overflow: hidden;
      position: relative;
    }

    /* 4:3 기본 비율, 반응형 */
    .stage {
      position: relative;
      width: 100%;
      aspect-ratio: 4 / 3;
      max-height: calc(100dvh - 220px);
      display: grid; place-items: center;
      background: repeating-conic-gradient(from 0deg, #0e1620 0 10deg, #0d141d 10deg 20deg);
    }

    /* 드래그 앤 드롭 안내 */
    .drop-hint {
      position: absolute; inset: 0; display: none; place-items: center; text-align: center;
      background: rgba(0,0,0,0.35);
      border: 2px dashed rgba(255,255,255,0.2);
      color: var(--muted);
      font-weight: 700; letter-spacing: .3px;
    }
    .stage.dragover .drop-hint { display: grid; }

    .footer-note {
      color: var(--muted); font-size: 12.5px; line-height: 1.5; opacity: .9;
      padding: 6px 2px 18px; text-align: center;
    }
    .footer-note a { color: var(--accent); text-decoration: none; }
    .file-warn{display:none;margin:8px 0 0;padding:14px 16px;border:1px dashed rgba(255,255,255,.25);border-radius:12px;background:linear-gradient(135deg, rgba(255,99,99,.1), rgba(255,166,0,.08));color:var(--text)}
  .file-warn code{background:rgba(0,0,0,.35);padding:2px 6px;border-radius:6px}
</style>
</head>
<body>
  <header>
    <h1>전쟁시대1 (Age of War)</h1>
    <span class="tag">Flash ▶ Ruffle</span>
    <span class="spacer"></span>
    <span class="tag">로컬 실행 가능</span>
  </header>

  <main class="wrap">
    <div class="toolbar" role="group" aria-label="플레이어 제어">
      <label class="btn btn-accent" for="fileInput">SWF 불러오기</label>
      <input id="fileInput" type="file" accept=".swf" hidden />

      <button id="btnLoadDefault" class="btn">기본 SWF 실행</button>
      <button id="btnFullscreen" class="btn">전체 화면</button>

      <div class="flex">
        <span style="font-size:13px;color:var(--muted);">배율</span>
        <input id="zoom" type="range" min="50" max="200" value="100" />
        <span id="zoomVal" style="width:44px;text-align:right;font-variant-numeric:tabular-nums;">100%</span>
        <button id="btnFit" class="btn">창에 맞추기</button>
        <button id="btnReset" class="btn">배율 초기화</button>
      </div>

      <span class="spacer"></span>
      <button id="btnReload" class="btn">다시 실행</button>
      <button id="btnClear" class="btn btn-danger" title="세이브/캐시 초기화">캐시 초기화</button>
    </div>

    <div class="player-shell">
      <div id="stage" class="stage" tabindex="0" aria-label="게임 무대 (클릭 후 키/마우스 입력)">
        <div class="drop-hint">SWF 파일을 여기로 드래그하세요</div>
      </div>
    </div>

    <p class="footer-note">
      ⚠️ 이 페이지는 Flash 원본 파일(SWF)이 <strong>법적으로 허용된 범위에서</strong> 제공되었을 때에만 동작합니다. 
      <br />
      <strong>권리자 허락 없이 배포된 SWF를 업로드하거나 공개 호스팅하는 것은 금지</strong>됩니다.
      <br />
      <small>엔진: <a href="https://ruffle.rs" target="_blank" rel="noreferrer noopener">Ruffle</a> · 로컬에서 실행 시 CORS 우회를 위해 간단한 웹서버 사용을 권장합니다.</small>
    </p>
      <div id="fileProtoWarning" class="file-warn">
      <strong>지금 <code>file://</code>로 열려 있어 Ruffle가 막혔습니다.</strong><br>
      아래 중 하나로 간단히 해결하세요:
      <ol style="margin:8px 0 0 18px;line-height:1.6">
        <li><b>VS Code → Live Server</b>로 <code>index.html</code> 열기</li>
        <li><b>Python</b>: 폴더에서 <code>python -m http.server 8000</code> 실행 후 <code>http://localhost:8000</code></li>
        <li><b>Node</b>: <code>npx http-server -p 8000</code></li>
        <li><b>Windows 배치</b>: 아래 내용을 <code>serve.bat</code>로 저장 후 더블클릭:
          <pre style="margin:6px 0;padding:8px;background:#0d141d;border-radius:10px;overflow:auto">@echo off
cd /d %~dp0
python -m http.server 8000
pause</pre>
        </li>
      </ol>
    </div>
  </main>

  <!-- Ruffle(Flash 에뮬레이터) -->
  <script src="https://unpkg.com/@ruffle-rs/ruffle"></script>
  <script>
    // ====== 기본 설정 ======
    // file:// 로 열었을 때 경고 노출
    document.addEventListener('DOMContentLoaded', ()=>{
      if (location.protocol === 'file:') {
        const el = document.getElementById('fileProtoWarning');
        if (el) el.style.display = 'block';
      }
    });
    const DEFAULT_SWF_PATH = "assets/age_of_war.swf"; // 여기에 SWF를 두면 [기본 SWF 실행]으로 로드됩니다

    const stage = document.getElementById('stage');
    const zoom = document.getElementById('zoom');
    const zoomVal = document.getElementById('zoomVal');
    const btnFit = document.getElementById('btnFit');
    const btnReset = document.getElementById('btnReset');
    const btnReload = document.getElementById('btnReload');
    const btnClear = document.getElementById('btnClear');
    const btnFs = document.getElementById('btnFullscreen');
    const btnLoadDefault = document.getElementById('btnLoadDefault');
    const fileInput = document.getElementById('fileInput');

    let rufflePlayer = null;
    let scale = 1;

    function makePlayer() {
      // 기존 플레이어 제거
      stage.querySelectorAll('ruffle-player, object, embed, canvas').forEach(n => n.remove());

      const ruffle = window.RufflePlayer?.newest();
      rufflePlayer = ruffle.createPlayer();
      rufflePlayer.style.width = '100%';
      rufflePlayer.style.height = '100%';
      rufflePlayer.style.transformOrigin = 'center center';
      stage.appendChild(rufflePlayer);

      // 포커스 받아서 키 입력 전달
      stage.addEventListener('click', () => stage.focus());
    }

    function loadFromUrl(url) {
      if (!rufflePlayer) makePlayer();
      rufflePlayer.load(url).catch(err => {
        console.error('SWF 로드 에러', err);
        alert('SWF를 불러오지 못했습니다. 파일 경로와 CORS 설정을 확인하세요.\n' + err);
      });
    }

    function loadFromFile(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const data = e.target.result; // ArrayBuffer
        if (!rufflePlayer) makePlayer();
        rufflePlayer.load({ data }).catch(err => {
          console.error('파일 로드 에러', err);
          alert('SWF 파일을 열 수 없습니다. 다른 파일을 시도해 보세요.');
        });
      };
      reader.readAsArrayBuffer(file);
    }

    function setScale(percent) {
      scale = Math.max(0.5, Math.min(2, percent / 100));
      zoomVal.textContent = Math.round(scale * 100) + '%';
      // 실제 스케일은 내부 컨텐츠 크기에 맞춰 transform으로 조절
      const playerEl = stage.querySelector('ruffle-player');
      if (playerEl) {
        playerEl.style.transform = `scale(${scale})`;
      }
    }

    function fitToStage() {
      // 4:3 기준으로 가로/세로에 맞춰 적절한 배율 계산
      const playerEl = stage.querySelector('ruffle-player');
      if (!playerEl) return;
      const stageRect = stage.getBoundingClientRect();
      // Ruffle 기본 내부 크기 추정 (SWF가 지정하면 달라질 수 있음) — 비율만 맞추기
      const baseW = 800, baseH = 600; // 4:3
      const scaleW = stageRect.width / baseW;
      const scaleH = stageRect.height / baseH;
      const s = Math.min(scaleW, scaleH);
      zoom.value = Math.round(s * 100);
      setScale(zoom.value);
    }

    function reload() {
      const currentSrc = rufflePlayer?.shadowRoot?.querySelector('embed')?.getAttribute('src');
      if (currentSrc) {
        loadFromUrl(currentSrc);
      } else {
        // 파일로 로드한 경우는 다시 파일을 선택해야 함
        makePlayer();
      }
    }

    function clearCaches() {
      try {
        localStorage.clear();
        sessionStorage.clear();
        caches && caches.keys && caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
      } catch (e) { /* ignore */ }
      alert('로컬 저장 데이터(세이브/캐시)를 초기화했습니다.');
    }

    // 이벤트 바인딩
    window.addEventListener('DOMContentLoaded', () => {
      makePlayer();
      setScale(100);
    });

    zoom.addEventListener('input', e => setScale(e.target.value));
    btnFit.addEventListener('click', fitToStage);
    btnReset.addEventListener('click', () => { zoom.value = 100; setScale(100); });
    btnReload.addEventListener('click', reload);
    btnClear.addEventListener('click', clearCaches);

    btnFs.addEventListener('click', () => {
      if (stage.requestFullscreen) stage.requestFullscreen();
      else if (stage.webkitRequestFullscreen) stage.webkitRequestFullscreen();
    });

    btnLoadDefault.addEventListener('click', () => loadFromUrl(DEFAULT_SWF_PATH));

    fileInput.addEventListener('change', (e) => loadFromFile(e.target.files?.[0]));

    // 드래그 앤 드롭 지원
    const hint = stage.querySelector('.drop-hint');
    ['dragenter','dragover'].forEach(type => stage.addEventListener(type, (e) => {
      e.preventDefault(); e.stopPropagation(); stage.classList.add('dragover'); hint.style.display = 'grid';
    }));
    ['dragleave','drop'].forEach(type => stage.addEventListener(type, (e) => {
      e.preventDefault(); e.stopPropagation(); stage.classList.remove('dragover'); hint.style.display = 'none';
    }));
    stage.addEventListener('drop', (e) => {
      const file = [...(e.dataTransfer?.files || [])].find(f => f.name.endsWith('.swf'));
      if (file) loadFromFile(file);
    });

    // 창 리사이즈 시 맞추기 버튼이 더 잘 맞도록 도우미
    window.addEventListener('resize', () => {
      // 사용자 커스텀 배율이 아닌 경우에만 자동 맞춤
      if (Number(zoom.value) === 100) {
        // 기본값 유지. 필요 시 주석 해제하여 자동 맞춤 사용 가능
        // fitToStage();
      }
    });
  </script>
</body>
</html>
